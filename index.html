<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>
    <title>Geolocation from py-script</title>

</head>
<body>

<div id="Header">
    <h1>Geolocation from py-script</h1>
</div>
<div id="map"></div>
<div id="accuracy"></div>

<py-env>
  - folium
</py-env>

<py-script>

import js
from pyodide.ffi import create_proxy
import folium

# Show the map
def showPosition(position):
    # Get DIV elements
    positionDIV = document.getElementById("map")
    accuracyDIV = document.getElementById("accuracy")
    # Get accuracy
    accuracyDIV.innerHTML = f"Accuracy: {position.coords.accuracy:.0f} meters."
    # Get position
    latitude = position.coords.latitude
    longitude = position.coords.longitude
    # Empty parameters
    tiles = ""
    attr = ""

    #check if position is inside Finland
    if latitude < 70.1 and latitude > 59.8 and longitude < 31.6 and longitude > 19.0:
        # Use Maastokartta tiles
        tiles = "https://tiles.kartat.kapsi.fi/peruskartta/{z}/{x}/{y}.jpg"
        attr = "Maanmittauslaitos"
    else:
        # Use OpenStreetMap tiles
        tiles = "OpenStreetMap"
        attr = None

    # Create map
    m = folium.Map(location=[latitude, longitude], zoom_start=15, tiles=tiles, attr=attr)
    # Create marker
    folium.Marker([latitude, longitude]).add_to(m)
    # Set HTML
    positionDIV.innerHTML = m._repr_html_()


# proxy the showPosition function
showPositionProxy = create_proxy(showPosition)

# call the geolocation API
if js.navigator.geolocation :
    # call the geolocation function
    js.navigator.geolocation.getCurrentPosition(showPositionProxy)
else:
    print("Geolocation is not supported!")

</py-script>

</body>
</html>